#!/bin/bash
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
NC='\033[0m'


# Parse arguments
while getopts 'h:u:p:?' opt; do
	case "$opt" in
		h)
			host="$OPTARG"
			;;
		u)
			username="$OPTARG"
			;;
		p)
			password="$OPTARG"
			;;
		:)
			echo -e "option requires an argument.\nUsage: $(basename $0) [-h <ip>] [-u <username>] [-p <password>]"
			exit 1
			;;
		?)
			echo -e "Invalid command option.\nUsage: $(basename $0) [-h <ip>] [-u <username>] [-p <password>]"
			;;
	esac
done
shift "$(($OPTIND -1))"

if [ -z "$host" ] || [ -z "$username" ] || [ -z "$password" ] ; then
	echo "Usage: $(basename $0) -h <ip> -u <username> -p <password>"
	exit 1
fi


# make dir with loot
mkdir smbloot-$username
cd smbloot-$username

# search for accessible shares and dump files
smbmap -H $host -u $username -p $password | grep 'READ\|WRITE' | cut -f2 | while read line ; do
	echo -e ${YELLOW}[*] Working on $line ${NC}
	mkdir $line
	cd $line
	echo "recurse on
	prompt off
	mget *" | smbclient -d 0 -q //$host/$line -U $username%$password 
	cd ..
	echo -e ${GREEN}[+] Done! ${NC}
done
